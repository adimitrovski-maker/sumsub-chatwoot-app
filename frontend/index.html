<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sumsub Chatwoot App</title>
    <style>
      body { font-family: system-ui, sans-serif; padding: 12px; }
      .card { background: #f5f5f5; padding: 12px; border-radius: 10px; margin-bottom: 12px; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .pill { font-size: 12px; background: #eee; padding: 4px 8px; border-radius: 999px; }
      .error { background: #ffe8e8; border: 1px solid #ffb3b3; padding: 10px; border-radius: 10px; }
      .ok { background: #e9ffe8; border: 1px solid #b6ffb3; padding: 10px; border-radius: 10px; }
      pre { white-space: pre-wrap; word-break: break-word; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
      button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
      select, input { box-sizing: border-box; }
    </style>
  </head>

  <body>
    <h3>Sumsub Chatwoot App</h3>

    <div class="row" style="margin-bottom: 10px;">
      <button id="request">Request context</button>
      <span class="pill" id="count">messages: 0</span>
    </div>

    <!-- Pills / top status -->
    <div class="card">
      <div class="row">
        <span class="pill" id="inboxPill">inbox: (waiting)</span>
        <span class="pill" id="brandPill">brand: (waiting)</span>
        <span class="pill" id="attrPill">attr: (waiting)</span>
        <span class="pill" id="backendPill">backend: (not checked)</span>
      </div>
    </div>

    <!-- Verification level -->
    <div class="card" style="margin-top: 10px;">
      <div style="font-weight: 600; margin-bottom: 6px;">Verification level</div>
      <select id="levelSelect" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc;">
        <option value="">Loading levels…</option>
      </select>
      <div id="levelHint" style="font-size: 12px; opacity: 0.8; margin-top: 6px;"></div>
    </div>

    <!-- Applicant details -->
    <div class="card" style="margin-top: 10px;">
      <div style="font-weight: 600; margin-bottom: 6px;">Applicant details</div>

      <div style="display: grid; gap: 8px;">
        <input id="firstName" placeholder="First name *" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc;" />
        <input id="middleName" placeholder="Middle name (optional)" style="width: 100%; padding: 8px; border-radius: 8px; border-radius: 8px; border: 1px solid #ccc;" />
        <input id="lastName" placeholder="Last name *" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc;" />
      </div>

      <div class="row" style="margin-top: 10px;">
        <button id="createApplicantBtn">Create applicant</button>
        <span class="pill" id="createStatus">create: (idle)</span>
      </div>

      <div id="createOutput" style="margin-top: 8px; font-size: 12px;"></div>
      <hr style="margin: 12px 0; border: none; border-top: 1px solid #ddd;" />

      <div style="font-weight: 600; margin-bottom: 6px;">Verification link</div>

      <div class="row" style="margin-top: 8px;">
       <button id="genLinkBtn">Generate link</button>
       <span class="pill" id="linkStatus">link: (idle)</span>
      </div>

      <div id="linkBox" style="margin-top: 8px;"></div>
    </div>

    <!-- Result / brand + external id status -->
    <div class="card" style="margin-top: 10px;" id="resultBox">
      Waiting for context…
    </div>

    <details>
      <summary>Raw context (debug)</summary>
      <pre id="raw">Waiting…</pre>
    </details>

    <script>
      let msgCount = 0;
      let currentInboxId = null;
      let currentBrand = null;
      let currentExternalUserId = null;
      let contactFullName = "";

      const inboxPill = document.getElementById("inboxPill");
      const brandPill = document.getElementById("brandPill");
      const attrPill = document.getElementById("attrPill");
      const resultBox = document.getElementById("resultBox");
      const raw = document.getElementById("raw");
      const countEl = document.getElementById("count");
      const backendPill = document.getElementById("backendPill");

      // Inbox → brand configuration
      const BRAND_MAP = [
        { brand: "Pikapotti", prefix: "PPTI-", inboxIds: [86179, 86339], backofficeAttrKey: "pptibackofficeid" },
        { brand: "Pelaa Nyt", prefix: "PN-", inboxIds: [64829, 82727, 67762, 66089], backofficeAttrKey: "backofficeid" },
        { brand: "Spinni", prefix: "SP-", inboxIds: [65464, 60941, 81712], backofficeAttrKey: "spbackofficeid" }
      ];

      // IMPORTANT: This must be your Render BACKEND Web Service URL (the one where /api/ping works)
      const BACKEND_BASE_URL = "https://sumsub-chatwoot-app.onrender.com";

      const levelSelect = document.getElementById("levelSelect");
      const levelHint = document.getElementById("levelHint");

      const firstNameEl = document.getElementById("firstName");
      const middleNameEl = document.getElementById("middleName");
      const lastNameEl = document.getElementById("lastName");
      const createApplicantBtn = document.getElementById("createApplicantBtn");
      const createStatus = document.getElementById("createStatus");
      const createOutput = document.getElementById("createOutput");
      const genLinkBtn = document.getElementById("genLinkBtn");
      const linkStatus = document.getElementById("linkStatus");
      const linkBox = document.getElementById("linkBox");

      function requestContext() {
        window.parent.postMessage("chatwoot-dashboard-app:fetch-info", "*");
      }

      function findBrandByInbox(inboxId) {
        return BRAND_MAP.find(b => b.inboxIds.includes(inboxId)) || null;
      }

      function isNumeric(value) {
        if (value === null || value === undefined) return false;
        const s = String(value).trim();
        if (!s) return false;
        return /^[0-9]+$/.test(s);
      }

      function prefillNamesFromFullName(fullName) {
        const name = String(fullName || "").trim();
        if (!name) return;

        // If the agent has already typed something, don't overwrite it
        if (firstNameEl.value || lastNameEl.value || middleNameEl.value) return;

        const parts = name.split(/\s+/).filter(Boolean);
        if (parts.length === 1) {
          firstNameEl.value = parts[0];
          lastNameEl.value = "";
          return;
        }
        if (parts.length === 2) {
          firstNameEl.value = parts[0];
          lastNameEl.value = parts[1];
          return;
        }

        firstNameEl.value = parts[0];
        lastNameEl.value = parts[parts.length - 1];
        middleNameEl.value = parts.slice(1, -1).join(" ");
      }

      async function checkBackend() {
        try {
          backendPill.textContent = "backend: checking…";
          const res = await fetch(`${BACKEND_BASE_URL}/api/ping`);
          const data = await res.json();
          backendPill.textContent = (data && data.ok) ? "backend: connected ✅" : "backend: unexpected response";
        } catch (e) {
          backendPill.textContent = "backend: not reachable ❌";
        }
      }

      async function loadVerificationLevels() {
        try {
          levelSelect.innerHTML = `<option value="">Loading levels…</option>`;
          levelHint.textContent = "";

          const res = await fetch(`${BACKEND_BASE_URL}/api/sumsub/levels`);
          const data = await res.json();

          if (!data.ok) {
            levelSelect.innerHTML = `<option value="">Failed to load levels</option>`;
            levelHint.textContent = data.error || "Unknown error";
            return;
          }

          const levels = Array.isArray(data.levelNames) ? data.levelNames : [];
          if (levels.length === 0) {
            levelSelect.innerHTML = `<option value="">No levels returned</option>`;
            levelHint.textContent = "Sumsub returned an empty list.";
            return;
          }

          levelSelect.innerHTML =
            `<option value="">Select a level…</option>` +
            levels.map(lvl => `<option value="${lvl}">${lvl}</option>`).join("");

          levelHint.textContent = "Levels loaded from Sumsub (dynamic).";
        } catch (e) {
          levelSelect.innerHTML = `<option value="">Failed to load levels</option>`;
          levelHint.textContent = String(e?.message || e);
        }
      }

      function renderStatus({ inboxId, brandInfo, backofficeValue }) {
        inboxPill.textContent = `inbox: ${inboxId ?? "(missing)"}`;

        if (!brandInfo) {
          brandPill.textContent = "brand: UNKNOWN";
          attrPill.textContent = "attr: (n/a)";
          currentInboxId = inboxId;
          currentBrand = null;
          currentExternalUserId = null;

          resultBox.innerHTML = `
            <div class="error">
              <strong>Unknown inbox:</strong> ${inboxId}.<br/>
              Please add this inbox ID to the brand mapping in the app.
            </div>
          `;
          return;
        }

        brandPill.textContent = `brand: ${brandInfo.brand}`;
        attrPill.textContent = `attr: ${brandInfo.backofficeAttrKey}`;

        currentInboxId = inboxId;
        currentBrand = brandInfo.brand;

        if (!isNumeric(backofficeValue)) {
          currentExternalUserId = null;
          resultBox.innerHTML = `
            <div class="error">
              <strong>Missing ${brandInfo.backofficeAttrKey} value.</strong><br/>
              This value must be present (numeric) to proceed with Sumsub for <strong>${brandInfo.brand}</strong>.
            </div>
          `;
          return;
        }

        const externalUserId = `${brandInfo.prefix}${String(backofficeValue).trim()}`;
        currentExternalUserId = externalUserId;

        resultBox.innerHTML = `
          <div class="ok">
            <div><strong>External ID:</strong> ${externalUserId}</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 6px;">
              Next step: use this External ID when creating/finding applicants in Sumsub.
            </div>
          </div>
        `;
      }

      window.addEventListener("message", (event) => {
        msgCount += 1;
        countEl.textContent = `messages: ${msgCount}`;

        const payload = {
          receivedAt: new Date().toISOString(),
          origin: event.origin,
          data: event.data
        };
        raw.textContent = JSON.stringify(payload, null, 2);

        let parsed = null;
        try {
          parsed = (typeof event.data === "string") ? JSON.parse(event.data) : event.data;
        } catch (e) {
          return;
        }

        const convo = parsed?.data?.conversation || parsed?.conversation || null;
        const contact = parsed?.data?.contact || parsed?.contact || convo?.meta?.sender || null;
        window.__cw_email = contact?.email || "";

        const inboxId = convo?.inbox_id ?? parsed?.data?.conversation?.inbox_id ?? null;
        const brandInfo = findBrandByInbox(inboxId);

        const customAttrs = contact?.custom_attributes || {};
        contactFullName = contact?.name || "";
        prefillNamesFromFullName(contactFullName);

        const backofficeValue = brandInfo ? customAttrs?.[brandInfo.backofficeAttrKey] : null;
        renderStatus({ inboxId, brandInfo, backofficeValue });
      });

      async function createApplicant() {
        try {
          createOutput.textContent = "";
          createStatus.textContent = "create: working…";

          const levelName = levelSelect.value;
          const firstName = String(firstNameEl.value || "").trim();
          const middleName = String(middleNameEl.value || "").trim();
          const lastName = String(lastNameEl.value || "").trim();

          if (!currentExternalUserId || !currentBrand || !currentInboxId) {
            createStatus.textContent = "create: missing external ID ❌";
            createOutput.textContent = "External ID is missing for this brand/inbox. Update the correct backoffice id attribute in Chatwoot.";
            return;
          }
          if (!levelName) {
            createStatus.textContent = "create: select level ❌";
            createOutput.textContent = "Please select a verification level first.";
            return;
          }
          if (!firstName || !lastName) {
            createStatus.textContent = "create: missing names ❌";
            createOutput.textContent = "First name and last name are required.";
            return;
          }

          const payload = {
            externalUserId: currentExternalUserId,
            brand: currentBrand,
            inboxId: currentInboxId,
            levelName,
            firstName,
            lastName,
            middleName
          };

          const res = await fetch(`${BACKEND_BASE_URL}/api/kyc/create-applicant`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await res.json();

          if (!data.ok) {
            createStatus.textContent = "create: failed ❌";
            createOutput.textContent = data.error || "Unknown error";
            return;
          }

          createStatus.textContent = data.reused ? "create: reused ✅" : "create: created ✅";
          createOutput.innerHTML =
            `<div><strong>Applicant ID:</strong> ${data.applicantId}</div>` +
            `<div><strong>External ID:</strong> ${data.externalUserId}</div>`;
        } catch (e) {
          createStatus.textContent = "create: error ❌";
          createOutput.textContent = String(e?.message || e);
        }
      }

      async function generateWebsdkLink() {
  try {
    linkStatus.textContent = "link: working…";
    linkBox.innerHTML = "";

    const levelName = levelSelect.value;
    if (!currentExternalUserId || !currentBrand || !currentInboxId) {
      linkStatus.textContent = "link: missing external ID ❌";
      linkBox.textContent = "External ID is missing for this brand/inbox. Update the correct backoffice id attribute in Chatwoot.";
      return;
    }
    if (!levelName) {
      linkStatus.textContent = "link: select level ❌";
      linkBox.textContent = "Please select a verification level first.";
      return;
    }

    // Optional: include email if available in context (we'll keep a variable)
    const payload = {
      externalUserId: currentExternalUserId,
      levelName,
      email: (window.__cw_email || "")
    };

    const res = await fetch(`${BACKEND_BASE_URL}/api/kyc/generate-websdk-link`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const data = await res.json();
    if (!data.ok) {
      linkStatus.textContent = "link: failed ❌";
      linkBox.textContent = data.error || "Unknown error";
      return;
    }

    const url = data.url;
    linkStatus.textContent = "link: ready ✅";

    linkBox.innerHTML = `
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input id="websdkUrl" value="${url}" readonly
          style="flex: 1; min-width: 260px; padding: 8px; border-radius: 8px; border: 1px solid #ccc; background: #fff;" />
        <button id="copyLinkBtn">Copy</button>
        <a href="${url}" target="_blank" rel="noreferrer" style="font-size: 12px;">Open</a>
      </div>
      <div style="font-size:12px; opacity:0.8; margin-top:6px;">
        This link is temporary and is not stored by the app.
      </div>
    `;

    document.getElementById("copyLinkBtn").addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(url);
        linkStatus.textContent = "link: copied ✅";
      } catch (e) {
        // fallback if clipboard is blocked
        const input = document.getElementById("websdkUrl");
        input.focus();
        input.select();
        linkStatus.textContent = "link: select & copy manually";
      }
    });

  } catch (e) {
    linkStatus.textContent = "link: error ❌";
    linkBox.textContent = String(e?.message || e);
  }
}

      document.getElementById("request").addEventListener("click", requestContext);
      createApplicantBtn.addEventListener("click", createApplicant);
      genLinkBtn.addEventListener("click", generateWebsdkLink);

      // Auto-run on load
      requestContext();
      checkBackend();
      loadVerificationLevels();
    </script>
  </body>
</html>
